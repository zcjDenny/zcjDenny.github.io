<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sigma播放器 - 许可证验证API</title>
    <!-- 使用正确的SQL.js CDN链接 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
      :root {
        --primary-color: #6e5494;
        --secondary-color: #4078c0;
        --accent-color: #ff6b6b;
        --success-color: #4caf50;
        --dark-bg: #0d1117;
        --dark-card: #161b22;
        --dark-text: #c9d1d9;
        --light-bg: #f5f8fa;
        --light-card: #ffffff;
        --light-text: #24292e;
        --border-radius: 8px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--light-bg);
        color: var(--light-text);
        line-height: 1.6;
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
      }

      .container {
        background-color: var(--light-card);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      h1 {
        color: var(--primary-color);
        margin-bottom: 20px;
        text-align: center;
      }

      .api-endpoint {
        margin: 20px 0;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary-color);
      }

      .endpoint-url {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        word-break: break-all;
      }

      .method {
        display: inline-block;
        padding: 4px 8px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 10px;
      }

      .params-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }

      .params-table th,
      .params-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .params-table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .response-example {
        background-color: #2b2b2b;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        overflow-x: auto;
        font-family: monospace;
        font-size: 14px;
      }

      .code-key {
        color: #f92672;
      }

      .code-string {
        color: #a6e22e;
      }

      .code-number {
        color: #ae81ff;
      }

      .code-boolean {
        color: #ae81ff;
      }

      .instructions {
        margin: 30px 0;
        padding: 20px;
        background-color: #e7f3ff;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--secondary-color);
      }

      .instructions h3 {
        color: var(--secondary-color);
        margin-bottom: 15px;
      }

      .instructions ol {
        margin-left: 20px;
      }

      .instructions li {
        margin-bottom: 10px;
      }

      .test-area {
        margin: 30px 0;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
      }

      .test-form {
        display: grid;
        gap: 15px;
        margin-top: 15px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-weight: 500;
        margin-bottom: 5px;
      }

      .form-group input, .form-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .btn {
        padding: 12px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        margin: 5px;
      }

      .btn:hover {
        background-color: var(--secondary-color);
      }

      .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .file-upload {
        margin: 15px 0;
      }

      .file-upload label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .db-status {
        margin: 10px 0;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
      }

      .test-result {
        margin-top: 20px;
        padding: 15px;
        background-color: #2b2b2b;
        color: #f8f8f2;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 10px;
        color: var(--primary-color);
      }

      .error {
        color: var(--accent-color);
        padding: 10px;
        background-color: #ffeaea;
        border-radius: 4px;
        margin: 10px 0;
      }

      .footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
        color: #666;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sigma播放器 - 许可证验证API</h1>

      <div class="instructions">
        <h3>使用说明</h3>
        <ol>
          <li>首先上传您的 api.db 数据库文件</li>
          <li>输入设备ID并选择操作类型进行测试</li>
          <li>验证设备状态：检查设备是否已注册</li>
          <li>注册新设备：将新设备信息添加到数据库</li>
          <li>试用期为6天，过期后需要输入授权码</li>
        </ol>
      </div>

      <div id="sqljsError" class="error" style="display: none;">
        SQL.js加载失败，正在使用本地存储模拟模式...
      </div>

      <div class="test-area">
        <h2>数据库操作</h2>

        <div class="file-upload">
          <label for="dbFile">上传数据库文件 (api.db)</label>
          <input type="file" id="dbFile" accept=".db,.sqlite,.sqlite3" />
        </div>

        <div class="db-status" id="dbStatus">
          请上传数据库文件
        </div>

        <h2>API测试工具</h2>
        <div class="test-form">
          <div class="form-group">
            <label for="deviceId">设备ID</label>
            <input
              type="text"
              id="deviceId"
              placeholder="输入设备ID"
              value=""
            />
          </div>
          <div class="form-group">
            <label for="action">操作类型</label>
            <select id="action">
              <option value="verify">验证设备状态</option>
              <option value="register">注册新设备</option>
            </select>
          </div>
          <div>
            <button class="btn" id="testBtn" onclick="testAPI()" disabled>测试API</button>
            <button class="btn" id="downloadBtn" onclick="downloadDatabase()" disabled>下载更新后的数据库</button>
          </div>
        </div>

        <div class="loading" id="loading">
          处理中，请稍候...
        </div>

        <div class="test-result" id="testResult">
          {/* 测试结果将在这里显示 */}
        </div>
      </div>

      <div class="footer">
        <p>© 2023 Sigma播放器 - 许可证验证API | 版本 1.0.0</p>
        <p>当前模式: <span id="modeIndicator">正在初始化...</span></p>
      </div>
    </div>

    <script>
      let db = null;
      let useLocalStorage = false;
      const TRIAL_DAYS = 6;
      const DB_KEY = "sigma_device_registry";

      // 初始化SQL.js
      function initSQLJS() {
        return new Promise((resolve, reject) => {
          if (typeof initSqlJs !== 'undefined') {
            initSqlJs({
              locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            }).then(SQL => {
              window.SQL = SQL;
              resolve(SQL);
            }).catch(error => {
              console.error('SQL.js初始化失败:', error);
              reject(error);
            });
          } else {
            reject(new Error('SQL.js未加载'));
          }
        });
      }

      // 初始化本地存储模式
      function initLocalStorage() {
        useLocalStorage = true;
        document.getElementById('modeIndicator').textContent = '本地存储模式';
        document.getElementById('sqljsError').style.display = 'block';

        if (!localStorage.getItem(DB_KEY)) {
          localStorage.setItem(DB_KEY, JSON.stringify({}));
        }

        const dbData = JSON.parse(localStorage.getItem(DB_KEY));
        document.getElementById('dbStatus').textContent = `本地存储模式，共有 ${Object.keys(dbData).length} 条记录`;
        document.getElementById('testBtn').disabled = false;
        document.getElementById('downloadBtn').disabled = false;

        // 隐藏文件上传，因为本地存储模式不需要文件
        document.querySelector('.file-upload').style.display = 'none';
      }

      // 初始化数据库
      function initDatabase() {
        if (useLocalStorage) {
          // 本地存储模式不需要文件上传
          return;
        }

        const fileInput = document.getElementById('dbFile');
        const dbStatus = document.getElementById('dbStatus');
        const testBtn = document.getElementById('testBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        if (fileInput.files.length === 0) {
          dbStatus.textContent = '请选择数据库文件';
          testBtn.disabled = true;
          downloadBtn.disabled = true;
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function() {
          try {
            const Uints = new Uint8Array(reader.result);
            db = new SQL.Database(Uints);

            // 检查表是否存在
            const tableCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='register'");
            if (tableCheck.length === 0) {
              // 表不存在，创建表
              db.exec(`
                CREATE TABLE register (
                  device_id TEXT PRIMARY KEY,
                  reg_date TEXT
                )
              `);
              dbStatus.textContent = '数据库已加载（新建表）';
            } else {
              // 显示记录数量
              const countResult = db.exec("SELECT COUNT(*) as count FROM register");
              const count = countResult[0].values[0][0];
              dbStatus.textContent = `数据库已加载，共有 ${count} 条记录`;
            }

            testBtn.disabled = false;
            downloadBtn.disabled = false;
          } catch (error) {
            dbStatus.textContent = '数据库加载失败: ' + error.message;
            testBtn.disabled = true;
            downloadBtn.disabled = true;
          }
        };

        reader.onerror = function() {
          dbStatus.textContent = '文件读取失败';
          testBtn.disabled = true;
          downloadBtn.disabled = true;
        };

        reader.readAsArrayBuffer(file);
      }

      // 获取设备信息（SQLite模式）
      function getDeviceInfoSQL(deviceId) {
        if (!db) return null;

        try {
          const result = db.exec("SELECT * FROM register WHERE device_id = ?", [deviceId]);
          if (result.length === 0 || result[0].values.length === 0) {
            return null;
          }

          const row = result[0].values[0];
          return {
            device_id: row[0],
            reg_date: row[1]
          };
        } catch (error) {
          console.error('查询设备信息失败:', error);
          return null;
        }
      }

      // 获取设备信息（本地存储模式）
      function getDeviceInfoLocal(deviceId) {
        const dbData = JSON.parse(localStorage.getItem(DB_KEY));
        return dbData[deviceId] || null;
      }

      // 注册新设备（SQLite模式）
      function registerDeviceSQL(deviceId) {
        if (!db) return null;

        try {
          const today = new Date();
          const regDate = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;

          // 检查设备是否已存在
          const existingDevice = getDeviceInfoSQL(deviceId);
          if (existingDevice) {
            return {
              device_id: deviceId,
              reg_date: existingDevice.reg_date,
              already_registered: true
            };
          }

          // 插入新设备
          db.exec("INSERT INTO register (device_id, reg_date) VALUES (?, ?)", [deviceId, regDate]);

          return {
            device_id: deviceId,
            reg_date: regDate,
            already_registered: false
          };
        } catch (error) {
          console.error('注册设备失败:', error);
          return null;
        }
      }

      // 注册新设备（本地存储模式）
      function registerDeviceLocal(deviceId) {
        const dbData = JSON.parse(localStorage.getItem(DB_KEY));
        const today = new Date();
        const regDate = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;

        if (dbData[deviceId]) {
          return {
            device_id: deviceId,
            reg_date: dbData[deviceId].reg_date,
            already_registered: true
          };
        }

        dbData[deviceId] = {
          device_id: deviceId,
          reg_date: regDate,
          registered_at: new Date().toISOString()
        };

        localStorage.setItem(DB_KEY, JSON.stringify(dbData));

        return {
          device_id: deviceId,
          reg_date: regDate,
          already_registered: false
        };
      }

      // 检查试用期是否过期
      function checkTrialExpired(regDate) {
        try {
          const start = new Date(regDate);
          const now = new Date();
          const diffTime = Math.abs(now - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays > TRIAL_DAYS;
        } catch (error) {
          console.error('检查试用期失败:', error);
          return false;
        }
      }

      // 计算剩余天数
      function calculateRemainingDays(regDate) {
        try {
          const start = new Date(regDate);
          const now = new Date();
          const diffTime = Math.abs(now - start);
          const daysUsed = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return Math.max(0, TRIAL_DAYS - daysUsed);
        } catch (error) {
          console.error('计算剩余天数失败:', error);
          return 0;
        }
      }

      // 处理API请求
      function handleAPIRequest(params) {
        const { action, device_id } = params;

        if (!device_id) {
          return {
            status: "error",
            message: "设备ID不能为空",
          };
        }

        if (action === "verify") {
          const deviceInfo = useLocalStorage ?
            getDeviceInfoLocal(device_id) :
            getDeviceInfoSQL(device_id);

          if (!deviceInfo) {
            return {
              status: "success",
              registered: false,
              message: "设备未注册",
            };
          }

          const expired = checkTrialExpired(deviceInfo.reg_date);
          const daysRemaining = calculateRemainingDays(deviceInfo.reg_date);

          return {
            status: "success",
            registered: true,
            start_date: deviceInfo.reg_date,
            days_remaining: daysRemaining,
            valid: !expired,
            expired: expired,
          };
        } else if (action === "register") {
          const deviceInfo = useLocalStorage ?
            registerDeviceLocal(device_id) :
            registerDeviceSQL(device_id);

          if (!deviceInfo) {
            return {
              status: "error",
              message: "设备注册失败",
            };
          }

          if (deviceInfo.already_registered) {
            return {
              status: "success",
              registered: true,
              message: "设备已注册",
              start_date: deviceInfo.reg_date,
            };
          }

          const daysRemaining = calculateRemainingDays(deviceInfo.reg_date);

          return {
            status: "success",
            message: "设备注册成功",
            start_date: deviceInfo.reg_date,
            days_remaining: daysRemaining,
          };
        } else {
          return {
            status: "error",
            message: "不支持的操作类型",
          };
        }
      }

      // 测试API
      function testAPI() {
        const deviceId = document.getElementById("deviceId").value.trim();
        const action = document.getElementById("action").value;
        const loading = document.getElementById("loading");
        const testResult = document.getElementById("testResult");

        if (!deviceId) {
          testResult.textContent = '请输入设备ID';
          return;
        }

        loading.style.display = 'block';
        testResult.textContent = '';

        setTimeout(() => {
          try {
            const result = handleAPIRequest({
              action: action,
              device_id: deviceId,
            });

            testResult.textContent = JSON.stringify(result, null, 2);
          } catch (error) {
            testResult.textContent = '处理请求时发生错误: ' + error.message;
          } finally {
            loading.style.display = 'none';
          }
        }, 100);
      }

      // 下载修改后的数据库（仅SQLite模式）
      function downloadDatabase() {
        if (useLocalStorage) {
          // 本地存储模式：导出为JSON文件
          const dbData = localStorage.getItem(DB_KEY);
          const blob = new Blob([dbData], {type: 'application/json'});
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = 'sigma_devices.json';
          a.click();

          URL.revokeObjectURL(url);
          return;
        }

        if (!db) {
          alert('请先上传数据库文件');
          return;
        }

        try {
          const data = db.export();
          const buffer = new Uint8Array(data);
          const blob = new Blob([buffer], {type: 'application/octet-stream'});
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = 'api_updated.db';
          a.click();

          URL.revokeObjectURL(url);
        } catch (error) {
          alert('下载数据库失败: ' + error.message);
        }
      }

      // 初始化页面
      document.addEventListener("DOMContentLoaded", function () {
        // 尝试初始化SQL.js，失败则使用本地存储
        initSQLJS().then(SQL => {
          window.SQL = SQL;
          document.getElementById('modeIndicator').textContent = 'SQLite模式';
          document.getElementById('dbFile').addEventListener('change', initDatabase);
        }).catch(error => {
          console.error('使用本地存储模式:', error);
          initLocalStorage();
        });
      });
    </script>
  </body>
</html>